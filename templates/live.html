<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Stampede Risk Feed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;600&display=swap');

    :root {
      --main-bg: linear-gradient(135deg, #f8fafc, #e0f2fe);
      --primary-color: #3b82f6;
      --primary-dark: #2563eb;
      --text-dark: #1e293b;
      --text-muted: #64748b;
      /* Status Colors */
      --status-critical-bg: #f8d7da;
      --status-critical-fg: #721c24;
      --status-warning-bg: #fff3cd;
      --status-warning-fg: #856404; /* Darker yellow for warning */
      --status-detected-bg: #fff3cd; /* Same as warning bg */
      --status-detected-fg: #c57d07; /* Orange/brown for detected */
      --status-normal-bg: #d4edda;
      --status-normal-fg: #155724;
      --status-unknown-bg: #e2e3e5;
      --status-unknown-fg: #383d41;
      --status-error-bg: var(--status-critical-bg);
      --status-error-fg: var(--status-critical-fg);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Poppins', sans-serif; background: var(--main-bg); color: var(--text-dark); animation: fadeIn 1s ease-in; position: relative; min-height: 100vh; padding-bottom: 80px; /* Footer height */ }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    header { background-color: #0f172a; color: white; padding: 15px 20px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); animation: slideDown 0.7s forwards ease-out; transform: translateY(-100%); }
    @keyframes slideDown { to { transform: translateY(0); } }

    h1 { font-size: 1.8rem; text-align: center; }
    hr { margin: 15px auto 25px; width: 50%; border: 0; height: 2px; background: var(--primary-color); }

    .description { text-align: center; margin: 0px 20px 15px; color: #475569; font-size: 0.95rem; }
    .status-info { text-align: center; margin-bottom: 20px; }
    .status-info h2 {
        font-size: 1.2rem; /* Slightly smaller */
        margin-bottom: 8px;
        padding: 6px 12px; /* Adjusted padding */
        display: inline-block;
        border-radius: 6px;
        font-weight: 600;
        min-width: 200px; /* Give some base width */
        transition: background-color 0.5s ease, color 0.5s ease, border-color 0.5s ease; /* Smooth transitions */
        border: 1px solid transparent; /* Base border */
    }
    .status-info h2#persons-heading {
         font-size: 1.1rem; /* Smaller for person count */
         font-weight: 500;
         background-color: #e9ecef; /* Neutral background */
         color: #495057;
         border: 1px solid #ced4da;
    }

    /* Status color classes */
    .status-critical { background-color: var(--status-critical-bg); color: var(--status-critical-fg); border-color: var(--status-critical-fg);}
    .status-warning { background-color: var(--status-warning-bg); color: var(--status-warning-fg); border-color: var(--status-warning-fg);}
    .status-detected { background-color: var(--status-detected-bg); color: var(--status-detected-fg); border-color: var(--status-detected-fg);}
    .status-normal { background-color: var(--status-normal-bg); color: var(--status-normal-fg); border-color: var(--status-normal-fg);}
    .status-unknown { background-color: var(--status-unknown-bg); color: var(--status-unknown-fg); border-color: var(--status-unknown-fg);}
    .status-error { background-color: var(--status-error-bg); color: var(--status-error-fg); border-color: var(--status-error-fg);}


    .video-container { display: flex; justify-content: center; margin: 30px auto; max-width: 90%; width: 800px; }
    .video-container img {
        max-width: 100%; border-radius: 12px;
        padding: 4px; background: linear-gradient(135deg, #a8c0ff, #3f2b96);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2); animation: pulseBorder 3s infinite ease-in-out;
        transition: transform 0.3s; display: block;
    }
    @keyframes pulseBorder { 0%, 100% { filter: brightness(1); } 50% { filter: brightness(1.1); } }
    .video-container img:hover { transform: scale(1.02); }

    .back-link { text-align: center; margin: 25px 0 10px; }
    .back-link a { background-color: var(--primary-color); color: white; text-decoration: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; transition: 0.3s ease; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3); }
    .back-link a:hover { background-color: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(59, 130, 246, 0.4); }

    .note { font-style: italic; color: #6b7280; font-size: 0.8rem; text-align: center; margin-top: 8px; max-width: 400px; margin-left: auto; margin-right: auto; }

    footer { text-align: center; padding: 15px; font-size: 0.9rem; color: var(--text-muted); background-color: #f1f5f9; border-top: 1px solid #e2e8f0; position: absolute; bottom: 0; width: 100%; }
    footer:hover { color: #334155; }

    #topBtn { position: fixed; bottom: 20px; right: 20px; display: none; background-color: var(--primary-dark); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25); z-index: 999; transition: background 0.3s, transform 0.2s; }
    #topBtn:hover { background-color: #1d4ed8; transform: scale(1.1); }

     @media (max-width: 768px) {
        h1 { font-size: 1.5rem; }
        .video-container { width: 95%; margin: 20px auto; }
        .status-info h2 { font-size: 1.0rem; min-width: 180px; } /* Adjust size */
        body { padding-bottom: 100px; } /* Adjust footer space */
     }

  </style>
</head>
<body>

  <header>
    <h1>Live Webcam Analysis</h1>
  </header>

  <hr>

  <p class="description">Displaying processed feed from webcam/video. Risk status and person count are updated below.</p>
  <p class="description" id="connection-status" style="font-weight: bold; color: var(--text-muted);">Connecting to status updates...</p>

  <div class="status-info">
      <h2 id="stampede-chance-heading" class="status-unknown">Stampede Chance: Initializing...</h2>
      <h2 id="persons-heading">Detected Persons: N/A</h2>
  </div>


  <div class="video-container">
    <img id="live-video-feed" src="{{ url_for('video_feed_route') }}" alt="Live Video Feed - Loading..." />
  </div>

  <div class="back-link">
    <a href="{{ url_for('index_route') }}">⬅ Back to Upload Page</a>
  </div>

  <footer style="background-color: #f8f9fa; padding: 15px 0; text-align: center; font-size: 0.9em; color: #555; border-top: 1px solid #ddd;">
    <div>
        <p>&copy; 2025 <span style="font-weight: 600;">Team Arete</span>. All rights reserved.</p>
        <p style="font-size: 0.8em; color: #888;">Stampede Prediction Project - YOLOv8</p>
    </div>
</footer>

  <button onclick="scrollToTop()" id="topBtn" title="Go to top">↑</button>

  <script>
    // --- Scroll-to-top Button Logic ---
    const topBtn = document.getElementById("topBtn");
    window.onscroll = function () {
      if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
        topBtn.style.display = "block";
      } else {
        topBtn.style.display = "none";
      }
    };
    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // --- Server-Sent Events (SSE) for Live Status Updates ---
    const chanceHeading = document.getElementById('stampede-chance-heading');
    const personsHeading = document.getElementById('persons-heading');
    const connectionStatus = document.getElementById('connection-status');
    const videoFeed = document.getElementById('live-video-feed'); // Get video feed img element

    console.log("Initializing SSE connection...");

    // Check if EventSource is supported
    if (typeof(EventSource) !== "undefined") {
      // Create an EventSource object pointing to the Flask SSE route
      const eventSource = new EventSource("{{ url_for('stream_status_route') }}");

      eventSource.onopen = function() {
        console.log("SSE connection established.");
        connectionStatus.textContent = "Live Status Connected";
        connectionStatus.style.color = "var(--status-normal-fg)"; // Green text
      };

      // Handle messages received from the server
      eventSource.onmessage = function(event) {
        // console.log("SSE Data Received:", event.data); // Debug log
        try {
          const data = JSON.parse(event.data);

          // Update Stampede Chance Heading Text and Style
          let chanceText = "Stampede Chance: Unknown";
          let chanceClass = "status-unknown"; // Default CSS class

          if (data.status) {
              const status = data.status; // e.g., "CRITICAL RISK", "Normal", "Error:..."
              if (status.includes("CRITICAL")) {
                  chanceText = `Stampede Chance: Critical`;
                  chanceClass = "status-critical";
              } else if (status.includes("Warning")) {
                  chanceText = `Stampede Chance: High`;
                  chanceClass = "status-warning";
              } else if (status.includes("Detected")) {
                  chanceText = `Stampede Chance: Moderate`; // Changed from High for clarity
                  chanceClass = "status-detected";
              } else if (status === "Normal") {
                  chanceText = "Stampede Chance: Low";
                  chanceClass = "status-normal";
              } else if (status.includes("Error") || status.includes("Incomplete")) {
                  chanceText = `Status: ${status}`; // Show the specific error/status
                  chanceClass = "status-error";
              } else {
                   chanceText = `Status: ${status}`; // Catch other statuses
                   chanceClass = "status-unknown";
              }
          }
          chanceHeading.textContent = chanceText;
          // Update the class for styling (remove old status, add new one)
          chanceHeading.className = ''; // Clear existing classes first
          chanceHeading.classList.add(chanceClass);


          // Update Persons Heading Text
          if (data.persons !== undefined && data.persons !== null) {
              personsHeading.textContent = `Detected Persons: ${data.persons}`;
          } else {
              personsHeading.textContent = `Detected Persons: N/A`;
          }

        } catch (e) {
          console.error("Error parsing SSE data:", e);
          chanceHeading.textContent = "Status Update Error";
          chanceHeading.className = 'status-error';
          personsHeading.textContent = "Persons: Error";
        }
      };

      // Handle errors with the SSE connection
      eventSource.onerror = function(err) {
        console.error("SSE Connection Error:", err);
        chanceHeading.textContent = "Status Connection Lost";
        chanceHeading.className = 'status-error';
        personsHeading.textContent = "Persons: N/A";
        connectionStatus.textContent = "Status Connection Failed";
        connectionStatus.style.color = "var(--status-error-fg)"; // Red text

        // Optionally close the connection and maybe try to reconnect after a delay
        eventSource.close();
        console.log("SSE connection closed due to error.");
        // Add reconnection logic here if desired
      };

    } else {
      // Browser doesn't support EventSource
      console.error("SSE not supported by this browser.");
      chanceHeading.textContent = "Live Updates Not Supported";
      chanceHeading.className = 'status-error';
      personsHeading.textContent = "Persons: N/A";
      connectionStatus.textContent = "Browser does not support live updates.";
      connectionStatus.style.color = "var(--status-error-fg)";
    }

    // Add error handler for the video feed image itself
    videoFeed.onerror = function() {
        console.error("Video feed failed to load.");
        connectionStatus.textContent = "Video Feed Failed to Load";
        connectionStatus.style.color = "var(--status-error-fg)";
        // Optionally display a placeholder image or message
        // videoFeed.alt = "Video feed failed.";
        // videoFeed.src = "path/to/placeholder_error_image.png";
    };

  </script>
</body>
</html>